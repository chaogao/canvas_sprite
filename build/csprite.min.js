/*! CanvasSprite 2013-04-10 */
(function(){var t,e=!1,r=[],n=[];try{Object.defineProperty({},"x",{})}catch(o){e=!0}if(t="undefined"!=typeof window&&window.__jstExtend?window.__jstExtend:function(t,i){if(3===arguments.length){var o=i,i={};i[o]=arguments[2]}for(name in i)if(Object.prototype.hasOwnProperty.call(i,name)){var a=i[name];if(e){for(var s=-1,c=0;r.length>c;c++)r[c]===t&&(s=c);s=0>s?r.push(t)-1:s,n[s]||(n[s]={}),n[s][name]={writable:"function"==typeof a,enumerable:!1,configurable:"function"==typeof a},t[name]=a}else Object.defineProperty(t,name,{value:a,writable:"function"==typeof a,enumerable:!1,configurable:"function"==typeof a})}},t(Array,{range:function(t,e,r){if(1===arguments.length)e=t,r=t=0>e?-1:1;else{if(0===arguments.length)return[];if(void 0===r)r=t>e?-1:1;else if(0===r||isNaN(r))throw new RangeError("Step must be an valid integer and not be equal to 0.")}r=Number(r),e=Number(e),t=Number(t);var n=[];if(t>e){if(r>=0)throw new RangeError("Stop must not be greater than start if step is to be positive.");for(var i=t,n=[];i>=e;n.push(i),i+=r);}if(e>t){if(0>=r)throw new RangeError("Stop must not be less than start if step is to be negative.");for(var i=t,n=[];e>=i;n.push(i),i+=r);}return n}}),t(Array.prototype,{concat$:function(){return Array.prototype.push.apply(this,arguments),this},swap:function(t,e){return this.clone().swap$(t,e)},swap$:function(t,e){if(!Object.hasOwnProperty.call(this,Number(t)))throw new RangeError("Array#swap: index1 does not exist within the array.");if(!Object.hasOwnProperty.call(this,Number(e)))throw new RangeError("Array#swap: index2 does not exist within the array.");var r=this[t];return this[t]=this[e],this[e]=r,this},contains:function(){return 0===arguments.length?!1:1===arguments.length?!!~this.indexOf(arguments[0]):Array.prototype.slice.call(arguments).every(function(t){return!!~this.indexOf(t)}.bind(this))},remove$:function(){return 0===arguments.length?this:(exclude=Array.prototype.slice.call(arguments),this.filter$(function(t){return!exclude.contains(t)}))},remove:function(){return 0===arguments.length?this.clone():(exclude=Array.prototype.slice.call(arguments),this.filter(function(t){return!exclude.contains(t)}))},shuffle:function(){for(var t=this.clone(),e=0;t.length-1>e;e++)t.swap$(e,Number.random(e,t.length-1).round());return t},shuffle$:function(){for(var t=0;this.length-1>t;t++)this.swap$(t,Number.random(t,this.length-1).round());return this},clone:function(){return this.slice()},intersect:function(){var t=(0===arguments.length?this:[this].concat(Array.prototype.slice.call(arguments))).map(function(t){return Array.isArray(t)?t.unique():[t]});return 0===t.length?[]:1===t.length?t[0]:t.shift().filter(function(e){return t.every(function(t){return!!~t.indexOf(e)})})},diff:function(){var t=Array.prototype.concat,e=t.apply([],t.apply(this,arguments));return 0===e.length?[]:1===e.length?arrays[0]:e.filter(function(t,e,r){return r.indexOf(t)===r.lastIndexOf(t)})},union:function(){var t=Array.prototype.concat,e=t.apply(this,arguments);return 0===e.length?[]:1===e.length?arrays[0]:t.apply([],e).unique()},chunk:function(t){for(var e=[];this.length>0;e.push(this.splice(0,t)));return e},chunk$:function(t){for(var e=0,r=this.length/t;r>e;e++)this.splice(e,0,this.splice(e,t));return this},unique:function(){return this.filter(function(t,e,r){return r.indexOf(t)===e})},each:function(t){var e,r=Object(this),n=arguments[1],i=this.length>>>0;if(!Function.isFunction(t))throw new TypeError(t+" is not a function.");for(var o=0;i>o;o++)if(o in r&&void 0!==(e=t.call(n,r[o],o,r)))return e},flatten:function(t){if(0===arguments.length)t=-1;else if(0===t)return this.clone();for(var e=0,r=this.clone();r.some(Array.isArray)&&e!=t;e++)r=Array.prototype.concat.apply([],r);return r},flatten$:function(t){0===arguments.length&&(t=-1);for(var e=0,r=this.length;r>e;e++)Array.isArray(this[e])&&0!=t&&this.splice.apply(this,[e,1].concat(this[e].flatten(t-1)));return this},sum:function(){return this.reduce(function(t,e){return Number(t)+Number(e)})},product:function(){return this.reduce(function(t,e){return Number(t)*Number(e)})},first:function(t){return arguments.length?this.slice(0,t||1):this[0]},last:function(t){return arguments.length?this.slice(this.length-(t||1)):this[this.length-1]},clean:function(){return this.filter(function(t){return!!t})},clean$:function(){return this.filter$(function(t){return!!t})},filter$:function(t,e){for(var r=0;this.length>r;r++)t.call(e,this[r],r,this)||this.splice(r,1)&&r--;return this},map$:function(t,e){for(var r=0;this.length>r;r++)this[r]=t.call(e,this[r],r,this);return this},invoke:function(t){return this.map(function(e){return e[t].apply(e,Array.prototype.slice.call(this,1))},arguments)},invoke$:function(t){return this.map$(function(e){return e[t].apply(e,Array.prototype.slice.call(this,1))},arguments)},pluck:function(t){return this.map(function(e){return Array.isArray(t)?Object.filter(e,t):e[t]})},pluck$:function(t){return this.map$(function(e){return Array.isArray(t)?Object.filter(e,t):e[t]})},grep:function(t){return this.filter(function(e){return!!e.match(t)})},grep$:function(t){return this.filter$(function(e){return!!e.match(t)})},sort$:function(t){var e="function"==typeof t?this.sort(t):this.sort();return e.forEach(function(t,e){this[e]=t},this),this},sortBy:function(t,e){if(void 0===t)return"function"==typeof e?this.sort(e):this.sort();void 0===e&&(e=function(t,e){return t+""-(e+"")});var r=this["function"==typeof t?"map":"pluck"](t).map(function(t,e){return{key:e,val:t}});return r.sort(function(t,r){return e(t.val,r.val)}).map(function(t){return this[t.key]},this)},sortBy$:function(t,e){return this.sortBy(t,e).forEach(function(t,e){this[e]=t},this),this},fetch:function(t){"function"==typeof t&&(t=this.map(t)),Array.isArray(t)||(t=Array.prototype.slice.call(arguments));var e=[];return t.forEach(function(t,r){e[t]=this[r]},this),e}}),Array.isArray||t(Array,"isArray",function(t){return"[object Array]"===Object.prototype.toString.call(t)}),Array.prototype.forEach||t(Array.prototype,"forEach",function(t){var e=Object(this),r=arguments[1],n=this.length>>>0;if(!Function.isFunction(t))throw new TypeError(t+" is not a function.");for(var i=0;n>i;i++)i in e&&t.call(r,e[i],i,e)}),Array.prototype.map||t(Array.prototype,"map",function(t){var e=Object(this),r=arguments[1],n=this.length>>>0,i=Array(n);if(!Function.isFunction(t))throw new TypeError(t+" is not a function.");for(var o=0;n>o;o++)o in e&&(i[o]=t.call(r,e[o],o,e));return i}),Array.prototype.filter||t(Array.prototype,"filter",function(t){var e=Object(this),r=arguments[1],n=this.length>>>0,i=[];if(!Function.isFunction(t))throw new TypeError(t+" is not a function.");for(var o=0;n>o;o++)o in e&&t.call(r,e[o],o,e)&&i.push(e[o]);return i}),Array.prototype.every||t(Array.prototype,"every",function(t){var e=Object(this),r=arguments[1],n=this.length>>>0;if(!Function.isFunction(t))throw new TypeError(t+" is not a function.");for(var i=0;n>i;i++)if(i in e&&!t.call(r,e[i],i,e))return!1;return!0}),Array.prototype.some||t(Array.prototype,"some",function(t){var e=Object(this),r=arguments[1],n=this.length>>>0;if(!Function.isFunction(t))throw new TypeError(t+" is not a function.");for(var i=0;n>i;i++)if(i in e&&t.call(r,e[i],i,e))return!0;return!1}),Array.prototype.reduce||t(Array.prototype,"reduce",function(t){var e=Object(this),r=arguments[1],n=this.length>>>0,i=0,o=i;if(!Function.isFunction(t))throw new TypeError(t+" is not a function.");if(1>=arguments.length){if(!n)throw new TypeError("Reduce of empty array with no initial value.");for(i=-1;e.length>o;o++)if(Object.hasOwnProperty.call(e,o+"")){i=o;break}if(-1===i)throw new TypeError("Reduce of empty array with no initial value.");r=e[i++]}for(;n>i;i++)Object.hasOwnProperty.call(e,i)&&(r=t.call(void 0,r,e[i],i,e));return r}),Array.prototype.reduceRight||t(Array.prototype,"reduceRight",function(t){var e=Object(this),r=arguments[1],n=this.length>>>0,i=n-1,o=i;if(!Function.isFunction(t))throw new TypeError(t+" is not a function.");if(1>=arguments.length){if(!n)throw new TypeError("Array length is 0 and no initial value given.");for(i=-1;o>=0;o--)if(Object.hasOwnProperty.call(e,o+"")){i=o;break}if(-1===i)throw new TypeError("Reduce of empty array with no initial value.");r=e[i--]}for(;i>=0;i--)Object.hasOwnProperty.call(e,i)&&(r=t.call(void 0,r,e[i],i,e));return r}),Array.prototype.indexOf||t(Array.prototype,"indexOf",function(t){var e=Object(this),r=this.length>>>0,n=1>=arguments.length?0:Number(arguments[1]);n=0>n?r-Math.abs(n):n;for(var i=n;r>i;i++)if(i in e&&e[i]===t)return i;return-1}),Array.prototype.lastIndexOf||t(Array.prototype,"lastIndexOf",function(t){if(void 0===this||null===this)throw new TypeError;var e=Object(this),r=this.length>>>0,n=r;if(0===r)return-1;arguments.length>1&&(n=Number(arguments[1]),n!==n?n=0:0!==n&&n!==1/0&&n!==-(1/0)&&(n=(n>0||-1)*Math.floor(Math.abs(n))));for(var i=n>=0?Math.min(n,r-1):r-Math.abs(n);i>=0;i--)if(i in e&&e[i]===t)return i;return-1}),t(Date.prototype,{fuzzyDiff:function(t,e,r){t instanceof Date||(t=new Date(t));for(var n=this.getTime()-t.getTime(),i={second:1e3,minute:6e4,hour:36e5,day:864e5,year:315576e5},o=Object.keys(i),a=Object.values(i),s=0;a.length>s;s++)if(1>n/a[s]||s==a.length){var c=n/a[s-1],u=o[s-1];return c>1&&(u+="s"),3>arguments.length&&(r=c.round()==c?"exactly":"about"),2>arguments.length&&(e="ago"),"%s %d %s %s".sprintf(r,c.round(),u,e)}}}),Date.now||t(Date,"now",function(){return(new Date).getTime()}),t(Date,{SECOND:1,MINUTE:60,HOUR:3600,DAY:86400,YEAR:31557600,DECADE:315576e3}),isNaN(Date.parse("2011-06-15T21:40:05+06:00"))&&(Date=function(t){var e=function(r,n,i,o,a,s,c){var u=arguments.length;if(this instanceof t){var h=1==u&&r+""===r?new t(e.parse(r)):u>=7?new t(r,n,i,o,a,s,c):u>=6?new t(r,n,i,o,a,s):u>=5?new t(r,n,i,o,a):u>=4?new t(r,n,i,o):u>=3?new t(r,n,i):u>=2?new t(r,n):u>=1?new t(r):new t;return h.constructor=e,h}return t.apply(this,arguments)},r=RegExp("^(\\d{4})(?:-(\\d{2})(?:-(\\d{2})(?:T(\\d{2}):(\\d{2})(?::(\\d{2})(?:\\.(\\d{3}))?)?(?:Z|(?:([-+])(\\d{2}):(\\d{2})))?)?)?)?$");for(var n in t)e[n]=t[n];return e.now=t.now,e.UTC=t.UTC,e.prototype=t.prototype,e.prototype.constructor=e,e.parse=function(e){var n=r.exec(e);if(n){n.shift();for(var i=1;7>i;i++)n[i]=+(n[i]||(3>i?1:0)),1==i&&n[i]--;var o=(+n.pop(),+n.pop()),a=n.pop(),s=0;if(a){if(o>23||minuteOffset>59)return 0/0;s=6e4*(60*o+minuteOffset)*("+"==a?-1:1)}return t.UTC.apply(this,n)+s}return t.parse.apply(this,arguments)},e}(Date)),t(Function,{isFunction:function(t){return"function"==typeof t&&!!t.call},compose:function(t){return Array.isArray(t)||(t=Array.prototype.slice.call(arguments)),t=t.reverse(),function(e){return t.reduce(function(t,e){return e(t)},e)}}}),t(Function.prototype,{cache:function(t,e){t=isNaN(t)?-1:t,e=e||function(t){return"object"==typeof t?Object.id(t):""+t};var r={},n=this,i={};return function(){var o=Array.prototype.slice.call(arguments),a="("+o.map(e).join(",")+")";return a in r?a in i&&(clearTimeout(i[a]),delete i[a]):r[a]=n.apply(n,o),t>0&&(i[a]=setTimeout(function(){delete r[a]},t)),r[a]}},delay:function(t,e,r){return setTimeout(function(e){t.apply(r,[this()].concat(Array.prototype.slice.call(e,2)))}.bind(this,arguments),e)},once:function(t){var e=!1,r=null;return function(n){return e||(e=!0,r=this.apply(t,n)),r}.bind(this,Array.prototype.slice.call(arguments))}}),Function.prototype.bind||t(Function.prototype,"bind",function(t){function e(){return n.apply(this instanceof i?this:t,r.concat(Array.prototype.slice.call(arguments)))}if(!Function.isFunction(this))throw new TypeError(this+" is not a function.");var r=Array.prototype.slice.call(arguments,1),n=this,i=function(){};return i.prototype=this.prototype,e.prototype=new i,e}),t(Number,{random:function(t,e){return(t=t||0)+((e||t+1)-t)*Math.random()}}),t(Number.prototype,{pow:function(t){return Math.pow(this,t)},ordinal:function(t){t=0===arguments.length?!0:!!t;var e="";if(this>=4&&20>=this)e="th";else switch(this%10){case 1:e="st";break;case 2:e="nd";break;case 3:e="rd";break;default:e="th"}return(t?this.round():"")+e},chr:function(){return String.fromCharCode(this)},odd:function(){return!this.even()},even:function(){return 0==this%2},gcd:function(){return Array.prototype.slice.call(arguments).reduce(function(t,e){if(0==t||0==e)return t|e;for(var r=0;0==(1&(t|e));r++)t>>=1,e>>=1;for(;0==(1&t);)t>>=1;do{for(;0==(1&e);)e>>=1;if(e>t)e-=t;else{var n=t-e;t=e,e=n}e>>=1}while(0!=e);return t<<r},this)},lcm:function(){var t=Array.prototype.slice.call(arguments),e=this.gcd.apply(this,t);return Math.abs(t.product()*this)/e},ceil:function(){return Math.ceil(this)},floor:function(){return Math.floor(this)},abs:function(){return Math.abs(this)},round:function(t){return t=t||0,0==t?Math.round(this):0>t?Number(this.toPrecision((""+this.floor()).length-t.abs())):Number(this.toFixed(t))},radix:function(t,e,r){return this.toString(t).pad(-e,r||"0")},bin:function(t,e){return this.radix(2,t,e)},oct:function(t,e){return this.radix(8,t,e)},dec:function(t,e){return this.radix(10,t,e)},hexl:function(t,e){return this.radix(16,t,e)},hex:function(t,e){return this.radix(16,t,e).toUpperCase()},abbr:function(t,e){e=!!(void 0==e?!1:e);var r={k:e?1024:1e3,M:e?1<<20:1e6,G:e?1<<30:1e9,T:e?Math.pow(2,40):1e12,P:e?Math.pow(2,50):1e15,E:e?Math.pow(2,60):1e18,Z:e?Math.pow(2,70):1e21,Y:e?Math.pow(2,80):1e24},n=Object.keys(r),i=Object.values(r);if(i[0]>this)return this.toFixed(t);for(var o=0;i.length>o;o++)if(1>this/i[o])return(this/i[o-1]).toFixed(t)+n[o-1];return(this/i.last()).toFixed(t)+n.last()}}),t(Object,{follow:function(t,e,r){if(!Array.isArray(e)){if("string"!=typeof e)throw new TypeError("Object.follow requires keys to either be an array or string value.");e=e.split(r||".")}return e.reduce(function(t,e){return t&&e in t?t[e]:void 0},t)},value:function(t,e){var r=Object.getOwnPropertyDescriptor(t,e);return r&&!Object.getOwnPropertyDescriptor(t,e).writable?t[e]:2===arguments.length?t[e]:t[e]=arguments[2]},remove:function(t,e){return Object.getOwnPropertyDescriptor(t,e).configurable?(t.__ownPropertyDescriptors__&&delete t.__ownPropertyDescriptors__[e],delete t[e]):!1},id:function(t){return r.contains(t)||r.push(t),r.indexOf(t)},alias:function(t,e,r,n){var i=Object.getOwnPropertyDescriptor(t,e);return n?(("get"in i||"value"in i)&&(delete i.value,delete i.writable,i.get=function(){return t[e]}),i.set=function(r){return t[e]=r},Object.defineProperty(t,r,i)):Object.defineProperty(t,r,i),t},values:function(t){var e=[];return Object.keys(t).forEach(function(r){e.push(t[r])}),e},forEach:function(t,e,r){return Object.keys(t).forEach(function(n){return e.call(r,n,t[n],t)})},isObject:function(){return Array.prototype.slice.call(arguments).every(function(t){return Object(t)===t})},each:function(t,e,r){var n,i;for(n in t)if("__proto__"!==n&&void 0!==(i=e.call(r,n,t[n],this)))return i},map:function(t,e,r){var n=Object.clone(t);return Object.map$(n,e,r),n},map$:function(t,e,r){return Object.forEach(t,function(n,i){Object.value(t,n,e.call(r,n,i))}),t},getOwnPropertyDescriptors:function(t){var e={};return Object.getOwnPropertyNames(t).forEach(function(r){e[r]=Object.getOwnPropertyDescriptor(t,r)}),e},reduce:function(t,e,r,n){return Object.forEach(t,function(i){r=e.call(n,r,i,t[i])}),r},merge:function(t,e){return Object.isObject(t,e)&&(t=Array.prototype.slice.call(arguments),e=0),e=void 0===e?0:e,t.reduce(function(t,r){return Object.forEach(r,function(r,n){t[r]=!n in t||0==e||!Object.isObject(t[r])||!Object.isObject(n)?n:Object.merge([t[r],n],e-1)}),t},{})},merge$:function(t,e,r){Array.isArray(e)?e=[t].concat(e):(e=Array.prototype.slice.call(arguments),r=void 0);var n=Object.merge.apply(void 0,e,r);return Object.filter$(t,function(t){return Object.hasOwnProperty.call(n,t)}),Object.map$(t,function(t){return n[t]}),Object.keys(n).diff(Object.keys(t)).forEach(function(e){Object.value(t,e,n[e])}),t},clone:function(t,e){e=void 0===e?!0:!1;var t=Object.create(Object.getPrototypeOf(t),e?Object.getOwnPropertyDescriptors(t):void 0);return t},filter:function(t,e,r){return Object.filter$(Object.clone(t),e,r)},filter$:function(t,e,r){if(Array.isArray(e))var n=e.invoke("toString");return Object.forEach(t,function(i,o){Array.isArray(e)?n.contains(i)||Object.remove(t,i):e.call(r,i,o,t)===!1&&Object.remove(t,i)}),t},clean:function(t){return Object.filter(t,function(t,e){return!!e})},clean$:function(t){return Object.filter$(t,function(t,e){return!!e})},size:function(t){return Object.keys(t).length},combine:function(t,e){var r={};return t.forEach(function(t,n){r[t]=e[n]}),r},hash:function(t){return Object.hash$(Object.clone(t))},hash$:function(t){return Object.defineProperties(t,{size:{value:function(){return Object.size(this)},writable:!0,enumerable:!1,configurable:!0},keys:{value:function(){return Object.keys(this)},writable:!0,enumerable:!1,configurable:!0},each:{value:function(t,e){return Object.each(this,t,e)},writable:!0,enumerable:!1,configurable:!0},forEach:{value:function(t,e){return Object.forEach(this,t,e)},writable:!0,enumerable:!1,configurable:!0},map:{value:function(t,e){return Object.map(this,t,e)},writable:!0,enumerable:!1,configurable:!0},map$:{value:function(t,e){return Object.map$(this,t,e)},writable:!0,enumerable:!1,configurable:!0},reduce:{value:function(t,e){return Object.reduce(this,t,e)},writable:!0,enumerable:!1,configurable:!0},filter:{value:function(t,e){return Object.filter(this,t,e)},writable:!0,enumerable:!1,configurable:!0},filter$:{value:function(t,e){return Object.filter$(this,t,e)},writable:!0,enumerable:!1,configurable:!0},clean:{value:function(t,e){return Object.clean(this,t,e)},writable:!0,enumerable:!1,configurable:!0},clean$:{value:function(t,e){return Object.clean$(this,t,e)},writable:!0,enumerable:!1,configurable:!0},clone:{value:function(t,e){return Object.clone(this,t,e)},writable:!0,enumerable:!1,configurable:!0},merge:{value:function(){return Object.merge.apply(void 0,[this].concat(Array.prototype.slice.call(arguments)))},writable:!0,enumerable:!1,configurable:!0},merge$:{value:function(){return Object.merge$.apply(void 0,[this].concat(Array.prototype.slice.call(arguments)))},writable:!0,enumerable:!1,configurable:!0}})}}),Object.getPrototypeOf||t(Object,"getPrototypeOf",function(t){return t.__proto__||t.constructor.prototype||s[Object.id(t)]}),!Object.getOwnPropertyDescriptor||e){var a=Object.getOwnPropertyDescriptor,n={};t(Object,"getOwnPropertyDescriptor",function(t,e){if(t.nodeType&&a)return a(t,e);if(!Object.isObject(t))throw new TypeError(t+" is not an object.");if(Object.prototype.hasOwnProperty.call(t,e)){var r,i,o={enumerable:Object.prototype.propertyIsEnumerable.call(t,e),writable:!0,configurable:!0},s=Object.id(t);return(t instanceof Function&&["arguments","length","name","prototype","caller"].contains(e)||t===Number&&["NaN","NEGATIVE_INFINITY","POSITIVE_INFINITY","MAX_VALUE","MIN_VALUE"].contains(e)||t===Math&&["LN10","PI","E","LOG10E","SQRT2","LOG2E","SQRT1_2","LN2"].contains(e))&&(o={configurable:!1,writable:!1,enumerable:!1}),t instanceof RegExp&&["lastIndex","multiline","global","source","ignoreCase"].contains(e)&&(o={configurable:!1,writable:"lastIndex"==e,enumerable:!1}),(Array.isArray(t)||String.isString(t))&&"length"===e?o={configurable:!1,writable:!0,enumerable:!1}:n[s]&&e in n[s]&&(o=n[s][e]),Object.prototype.__lookupGetter__&&(r=t.__lookupGetter__(e))&&(o.writable=!1,o.get=r),Object.prototype.__lookupSetter__&&(i=t.__lookupSetter__(e))&&(o.writable=!1,o.set=i),"set"in o||"get"in o||(o.value=t[e]),o}})}if(Object.getOwnPropertyNames||t(Object,"getOwnPropertyNames",function(t){var e=Object.keys(t);return("undefined"!=typeof globals&&t===globals||"undefined"!=typeof window&&t===window)&&e.push("Infinity","NaN","undefined","decodeURI","encodeURIComponent","isNaN","decodeURIComponent","eval","parseFloat","encodeURI","isFinite","parseInt"),t instanceof Function&&e.push("arguments","length","name","prototype","caller"),t===Number?e.push("NaN","NEGATIVE_INFINITY","POSITIVE_INFINITY","MAX_VALUE","MIN_VALUE"):t===Math?e.push("LN10","PI","E","LOG10E","SQRT2","LOG2E","SQRT1_2","LN2","cos","pow","log","tan","sqrt","ceil","asin","abs","max","exp","atan2","random","round","floor","acos","atan","min","sin"):t===String?e.push("fromCharCode"):t===Date?e.push("UTC","parse"):t===RegExp?e.push("$*","$3","$`","$9","rightContext","multiline","$7","lastParen","$input","$+","$&","leftContext","$8","$4","$1","$'","$_","input","lastMatch","$2","$5","$6"):t===Date.prototype?e.push("constructor","toUTCString","setMinutes","setUTCMonth","getMilliseconds","getTime","getMinutes","getUTCHours","toString","setUTCFullYear","setMonth","getUTCMinutes","getUTCDate","setSeconds","toLocaleDateString","getMonth","toTimeString","toLocaleTimeString","setUTCMilliseconds","setYear","getUTCFullYear","getFullYear","getTimezoneOffset","setDate","getUTCMonth","getHours","toLocaleString","toISOString","toDateString","getUTCSeconds","valueOf","setUTCMinutes","getUTCDay","setUTCDate","setUTCSeconds","getYear","getUTCMilliseconds","getDay","setFullYear","setMilliseconds","setTime","setHours","getSeconds","toGMTString","getDate","setUTCHours"):t===Object.prototype?e.push("toString","toLocaleString","hasOwnProperty","valueOf","constructor","propertyIsEnumerable","isPrototypeOf"):t===Number.prototype?e.push("toExponential","toString","toLocaleString","toPrecision","valueOf","constructor","toFixed"):t===RegExp.prototype?e.push("toString","constructor","exec","compile","test"):t===String.prototype?e.push("length","constructor","concat","localeCompare","substring","italics","charCodeAt","strike","indexOf","toLowerCase","toString","toLocaleLowerCase","replace","toUpperCase","fontsize","split","substr","sub","charAt","blink","lastIndexOf","sup","fontcolor","valueOf","link","bold","anchor","small","search","fixed","big","match","toLocaleUpperCase","slice"):t===Array.prototype?e.push("length","constructor","concat","sort","join","indexOf","toString","splice","shift","unshift","toLocaleString","reverse","pop","push","slice"):t===Function.prototype?e.push("toString","constructor","call","apply","arguments","length","name","prototype","caller"):t instanceof RegExp?e.push("lastIndex","multiline","global","source","ignoreCase"):(Array.isArray(t)||String.isString(t))&&e.push("length"),e.concat(Object.keys(n[Object.id(t)]||{})).unique()}),!Object.create){var s=[];t(Object,"create",function(t,e){if(null!==t&&Object(t)!==t)throw new TypeError("Object prototype may only be an Object or null");var r={};if(null!==t){var n=function(){};n.prototype=t,r=new n}return void 0!==e&&Object.defineProperties(r,e),void 0!==r.__proto__?r.__proto__=t:s[Object.id(r)]=t,r})}if(!Object.defineProperty||e){var c=Object.defineProperty,u=function(t,e,r){if(!Object.isObject(r))return"Property description must be an object: "+r;if(!Object.isObject(t))return"Object.defineProperty called on non-object";if("get"in r){if(!t.__defineGetter__)return"Getters are not supported on this javascript engine.";if(!Function.isFunction(r.get))return"Getter must be a function: "+r.get}if("set"in r){if(!t.__defineSetter__)return"Setters are not supported on this javascript engine.";if(!Function.isFunction(r.set))return"Setter must be a function: "+r.get}return("get"in r||"set"in r)&&("value"in r||r.writable)?"A property cannot both have accessors and be writable or have a value: "+t:void 0};t(Object,"defineProperty",function(t,e,r){t.nodeType&&c&&c(t,e,r);var i,o,a=Object.id(t);if(i=u(t,e,r))throw new TypeError(i);return t.__defineGetter__&&(e in t&&t.__lookupGetter__(e)&&(o=t.__proto__,t.__proto__=Object.prototype,delete t[e]),"get"in r&&t.__defineGetter__(e,r.get),"set"in r&&t.__defineSetter__(e,r.set)),n[a]||(n[a]={}),r.writable||(r.writable=!1),r.configurable||(r.configurable=!1),r.enumerable||(r.enumerable=!1),"get"in r||"set"in r||(t[e]=r.value),n[a][e]=r,o&&(t.__proto__=o),t})}if((!Object.defineProperties||e)&&t(Object,"defineProperties",function(t,e){if(!Object.isObject(t))throw new TypeError("Object.defineProperties called on non-object");var r,n;for(r in e)if(n=u(t,r,e[r]))throw new TypeError(n);for(r in e)Object.defineProperty(t,r,e[r]);return t}),!Object.seal)var h=[];if(t(Object,"seal",function(t){if(!Object.isObject(t))throw new TypeError("Object.seal called on non-object");return h[Object.id(t)]=!0,t}),Object.isSealed||t(Object,"isSealed",function(t){if(!Object.isObject(t))throw new TypeError("Object.isSealed called on non-object");return!!h[Object.id(t)]}),!Object.freeze)var l=[];if(t(Object,"freeze",function(t){if(!Object.isObject(t))throw new TypeError("Object.freeze called on non-object");return l[Object.id(t)]=!0,t}),Object.isFrozen||t(Object,"isFrozen",function(t){if(!Object.isObject(t))throw new TypeError("Object.isFrozen called on non-object");return!!l[Object.id(t)]}),!Object.preventExtensions)var p=[];if(t(Object,"preventExtensions",function(t){if(!Object.isObject(t))throw new TypeError("Object.preventExtensions called on non-object");return p[Object.id(t)]=!0,t}),Object.isExtensible||t(Object,"isExtensible",function(t){if(!Object.isObject(t))throw new TypeError("Object.isExtensible called on non-object");var e=Object.id(t);return!p[e]&&!h[e]}),Object.keys||t(Object,"keys",function(t){if(t!==Object(t))throw new TypeError("Object.keys called on non-object");var e,r=[];for(e in t)t.hasOwnProperty(e)&&r.push(e);return r=r.filter(function(e){return Object.prototype.propertyIsEnumerable.call(t,e)}),!String.isString(t)||0 in new String(" ")||(r=r.concat(Array.range(0,t.length-1))),r.map(String)}),e){var f=Object.prototype.propertyIsEnumerable;Object.prototype.propertyIsEnumerable=function(t){var e=n[Object.id(this)];if(e&&e[t])return e[t].enumerable===!0;if(f)f.call(this,t);else for(var r in this)if(r==t)return!0;return!0}}t(RegExp,{escape:function(t){return t.replace(/([/'*+?|()\[\]{}.^$])/g,"\\$1")}}),"undefined"!=typeof module&&module.exports&&(module.exports.repl=function(){var t=(require("vm"),require("repl"));process.stdin.removeAllListeners("keypress");var e=t.start("toolkit> ").context;e.Array=Array,e.Object=Object,e.Number=Number,e.Date=Date,e.RegExp=RegExp,e.String=String,e.Function=Function}),t(String,{isString:function(t){return"string"==typeof t||t instanceof String},UUID:function(){return Array.range(0,35).map(function(t){switch(t){case 8:case 13:case 23:return"-";case 14:t=4;break;case 19:t=8|3&Number.random(0,16).floor();break;default:t=Number.random(0,16).floor()}return"0123456789ABCDEF".charAt(t)}).join("")}}),t(String.prototype,{repeat:function(t){for(var e="",r=0,e="";(t||1)>r;r++)e+=this;return e},chars:function(){for(var t=0,e=[];this.length>t;t++)e.push(this.charAt(t));return e},count:function(t,e){return this.match(RegExp(t,e||"gi")).length},insert:function(t,e){return this.substr(0,e||0)+t+this.substr(e||0)},remove:function(t,e){return t instanceof RegExp||(t=RegExp(t,e||"gmi")),this.replace(t,"")},reverse:function(){return this.chars().reverse().join("")},ucfirst:function(){return this.charAt(0).toUpperCase()+this.substr(1)},swapcase:function(){return this.chars().map(function(t){return/[a-z]/.test(t)?t.toUpperCase():t.toLowerCase()}).join("")},rpad:function(t,e){if(t=Number(t),this.length>t)return this.valueOf();for(var r=this;t>r.length;r+=e||" ");return r.substr(0,t)},lpad:function(t,e){if(t=Number(t),this.length>t)return this.valueOf();e=(e||" ").reverse();for(var r=this;t>r.length;r=e+r);return r.substr(r.length-t)},pad:function(t,e){return this[t>0?"rpad":"lpad"](Math.abs(t),e)},soundex:function(){return this.substr(0,1).toUpperCase()+this.toUpperCase().substr(1).remove(/[^A-Z]/gi).trim().replace(/DG/g,"G").replace(/GH/g,"H").replace(/GN|KN/g,"N").replace(/PH/g,"F").replace(/MP([STZ])/g,"M$1").replace(/^PS/g,"S").replace(/^PF/g,"F").replace(/MB/g,"M").replace(/TCH/g,"CH").replace(/[AEIOUHWY]/g,"0").replace(/[BFPV]/g,"1").replace(/[CGJKQSXZ]/g,"2").replace(/[DT]/g,"3").replace(/[L]/g,"4").replace(/[MN]/g,"5").replace(/[R]/g,"6").replace(/(\w)\1+/g,"$1").slice(0,3).rpad(3,"0")},distance:function(t){var e,r,n,i,o,a=(e=this.split("")).length,s=(t=t.split("")).length;if(!a&&!s)return Math.max(a,s);for(var c=[],r=a+1;r;c[--r]=[r]);for(r=s+1;c[0][--r]=r;);for(r=-1,i=e.length;i>++r;)for(n=-1,o=t.length;o>++n;)c[(r*=1)+1][(n*=1)+1]=Math.min(c[r][n+1]+1,c[r+1][n]+1,c[r][n]+(e[r]!=t[n]));return c[a][s]},soundex:function(){return this.substr(0,1).toUpperCase()+this.toUpperCase().substr(1).remove(/[^A-Z]/gi).trim().replace(/DG/g,"G").replace(/GH/g,"H").replace(/GN|KN/g,"N").replace(/PH/g,"F").replace(/MP([STZ])/g,"M$1").replace(/^PS/g,"S").replace(/^PF/g,"F").replace(/MB/g,"M").replace(/TCH/g,"CH").replace(/[AEIOUHWY]/g,"0").replace(/[BFPV]/g,"1").replace(/[CGJKQSXZ]/g,"2").replace(/[DT]/g,"3").replace(/[L]/g,"4").replace(/[MN]/g,"5").replace(/[R]/g,"6").replace(/(\w)\1+/g,"$1").rpad(3,"0")},chunk:function(t){return this.chars().chunk(t).map(function(t){return t.join("")})},btoa:function(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e="",r=this.valueOf();for(i=0;r.length>i;i+=3){var n=r.charCodeAt(i),o=r.charCodeAt(i+1),a=r.charCodeAt(i+2),s=n>>2,c=(3&n)<<4|o>>4,u=(15&o)<<2|a>>6,h=63&a;isNaN(n)?u=h=64:isNaN(a)&&(h=64),e+=t.charAt(s)+t.charAt(c)+t.charAt(u)+t.charAt(h)}return e},atob:function(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e=this;return e.split("\n").map(function(e){var r="";for(i=0;e.length>i;i+=4){var n=t.indexOf(e.charAt(i)),o=t.indexOf(e.charAt(i+1)),a=t.indexOf(e.charAt(i+2)),s=t.indexOf(e.charAt(i+3)),c=n<<2|o>>4,u=(15&o)<<4|a>>2,h=(3&a)<<6|s;r+=String.fromCharCode(c),64!=a&&(r+=String.fromCharCode(u)),64!=s&&(r+=String.fromCharCode(h))}return r}).join("")},sprintf:function(){var t=arguments,e=/%%|%(?:(\d+)[\$#])?([+-])?('.|0| )?(\d*)(?:\.(\d+))?([bcdfosuxX])/g,r=0;return this.replace(e,function(e,n,i,o,a,s,c){if("%%"==e)return"%";switch(n=n||"",i=i||"",o=(o||"").slice(-1)||" ",a=a||"",s=s||"",val=t[+n?n-1:r],r++,c.match(/[duobxXf]{1}/)?val=Number(val):val+="",c){case"d":case"u":return val.dec(i+a,o);case"o":return val.oct(i+a,o);case"b":return val.bin(i+a,o);case"x":return val.hexl(i+a,o);case"X":return val.hex(i+a,o);case"s":return val.pad(i+a,o);case"c":return String.fromCharCode(val).pad(i+a,o);case"f":return val=s?val.toFixed(s):a?val.toExponential(a):val.toExponential(),i="-"==i?"+":"-",(""+val).pad(i+a,o)}})}}),String.prototype.trim||t(String.prototype,"trim",function(){return this.trimRight().trimLeft()}),String.prototype.trimRight||t(String.prototype,"trimRight",function(){return this.remove(/^\s\s*/)}),String.prototype.trimLeft||t(String.prototype,"trimLeft",function(){return this.remove(/\s\s*$/)})})(),function(t){"use strict";function e(){}function r(t,e){if(i)return e.indexOf(t);for(var r=e.length;r--;)if(e[r]===t)return r;return-1}var n=e.prototype,i=Array.prototype.indexOf?!0:!1;n._getEvents=function(){return this._events||(this._events={})},n.getListeners=function(t){var e=this._getEvents();return e[t]||(e[t]=[])},n.addListener=function(t,e){var n=this.getListeners(t);return-1===r(e,n)&&n.push(e),this},n.on=n.addListener,n.removeListener=function(t,e){var n=this.getListeners(t),i=r(e,n);return-1!==i&&(n.splice(i,1),0===n.length&&this.removeEvent(t)),this},n.off=n.removeListener,n.addListeners=function(t,e){return this.manipulateListeners(!1,t,e)},n.removeListeners=function(t,e){return this.manipulateListeners(!0,t,e)},n.manipulateListeners=function(t,e,r){var n,i,o=t?this.removeListener:this.addListener,a=t?this.removeListeners:this.addListeners;if("object"==typeof e)for(n in e)e.hasOwnProperty(n)&&(i=e[n])&&("function"==typeof i?o.call(this,n,i):a.call(this,n,i));else for(n=r.length;n--;)o.call(this,e,r[n]);return this},n.removeEvent=function(t){return t?delete this._getEvents()[t]:delete this._events,this},n.emitEvent=function(t,e){for(var r,n=this.getListeners(t),i=n.length;i--;)r=e?n[i].apply(null,e):n[i](),r===!0&&this.removeListener(t,n[i]);return this},n.trigger=n.emitEvent,n.emit=function(t){var e=Array.prototype.slice.call(arguments,1);return this.emitEvent(t,e)
},"function"==typeof define&&define.amd?define(function(){return e}):t.EventEmitter=e}(this),function(){function t(t){var e,n,i,o,a,s;for(i=t.length,n=0,e="";i>n;){if(o=255&t.charCodeAt(n++),n==i){e+=r.charAt(o>>2),e+=r.charAt((3&o)<<4),e+="==";break}if(a=t.charCodeAt(n++),n==i){e+=r.charAt(o>>2),e+=r.charAt((3&o)<<4|(240&a)>>4),e+=r.charAt((15&a)<<2),e+="=";break}s=t.charCodeAt(n++),e+=r.charAt(o>>2),e+=r.charAt((3&o)<<4|(240&a)>>4),e+=r.charAt((15&a)<<2|(192&s)>>6),e+=r.charAt(63&s)}return e}function e(t){var e,r,i,o,a,s,c;for(s=t.length,a=0,c="";s>a;){do e=n[255&t.charCodeAt(a++)];while(s>a&&-1==e);if(-1==e)break;do r=n[255&t.charCodeAt(a++)];while(s>a&&-1==r);if(-1==r)break;c+=String.fromCharCode(e<<2|(48&r)>>4);do{if(i=255&t.charCodeAt(a++),61==i)return c;i=n[i]}while(s>a&&-1==i);if(-1==i)break;c+=String.fromCharCode((15&r)<<4|(60&i)>>2);do{if(o=255&t.charCodeAt(a++),61==o)return c;o=n[o]}while(s>a&&-1==o);if(-1==o)break;c+=String.fromCharCode((3&i)<<6|o)}return c}var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1];window.btoa||(window.btoa=t),window.atob||(window.atob=e)}();var Canvas2Image=function(){var t=!1,e=document.createElement("canvas");if(e.getContext("2d")&&(t=!0),!t)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};var r=!!e.getContext("2d").getImageData,n=!!e.toDataURL,i=!!window.btoa,o="image/octet-stream",a=function(t){var e=parseInt(t.width),r=parseInt(t.height);return t.getContext("2d").getImageData(0,0,e,r)},s=function(t){var e="";if("string"==typeof t)e=t;else for(var r=t,n=0;r.length>n;n++)e+=String.fromCharCode(r[n]);return btoa(e)},c=function(t){var e=[],r=t.width,n=t.height;e.push(66),e.push(77);var i=3*r*n+54;e.push(i%256),i=Math.floor(i/256),e.push(i%256),i=Math.floor(i/256),e.push(i%256),i=Math.floor(i/256),e.push(i%256),e.push(0),e.push(0),e.push(0),e.push(0),e.push(54),e.push(0),e.push(0),e.push(0);var o=[];o.push(40),o.push(0),o.push(0),o.push(0);var a=r;o.push(a%256),a=Math.floor(a/256),o.push(a%256),a=Math.floor(a/256),o.push(a%256),a=Math.floor(a/256),o.push(a%256);var c=n;o.push(c%256),c=Math.floor(c/256),o.push(c%256),c=Math.floor(c/256),o.push(c%256),c=Math.floor(c/256),o.push(c%256),o.push(1),o.push(0),o.push(24),o.push(0),o.push(0),o.push(0),o.push(0),o.push(0);var u=3*r*n;o.push(u%256),u=Math.floor(u/256),o.push(u%256),u=Math.floor(u/256),o.push(u%256),u=Math.floor(u/256),o.push(u%256);for(var h=0;16>h;h++)o.push(0);var l=(4-3*r%4)%4,p=t.data,f="",d=n;do{for(var g=4*r*(d-1),y="",b=0;r>b;b++){var m=4*b;y+=String.fromCharCode(p[g+m+2]),y+=String.fromCharCode(p[g+m+1]),y+=String.fromCharCode(p[g+m])}for(var v=0;l>v;v++)y+=String.fromCharCode(0);f+=y}while(--d);var w=s(e.concat(o))+s(f);return w},u=function(t){window.open(t)},h=function(t,e){return"data:"+e+";base64,"+t},l=function(t){var e=document.createElement("img");return e.src=t,e},p=function(t,e,r){if(e&&r){var n=document.createElement("canvas");n.width=e,n.height=r,n.style.width=e+"px",n.style.height=r+"px";var i=n.getContext("2d");return i.drawImage(t,0,0,t.width,t.height,0,0,e,r),n}return t};return{saveAsPNG:function(t,e,r,i,o){if(!n)return!1;var a=p(t,i,o),s=a.toDataURL("image/png");return e?l(s):r?s:(u(s),!0)},saveAsJPEG:function(t,e,r,i){if(!n)return!1;var a=p(t,r,i),s="image/jpeg",c=a.toDataURL(s);return 5!=c.indexOf(s)?!1:e?l(c):(u(c.replace(s,o)),!0)},saveAsBMP:function(t,e,n,s){if(!r||!i)return!1;var f=p(t,n,s),d=a(f),g=c(d);return e?l(h(g,"image/bmp")):(u(h(g,o)),!0)}}}();(function(){window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,16.666)}}(),Csprite=function(){},Csprite.init=function(){var t=document.createElement("div");t.id="swfloader",document.body.appendChild(t),swfobject.embedSWF(Csprite.Const.flashUrl,"swfloader","1","1","11.1.0")},Csprite.Const={FPS:24,flashUrl:"../build/convertBase64.swf"},Csprite.extend=function(t,e,r){var n=null;"function"==typeof r?n=r:r===!0||r===void 0||(n=defaultFilter);for(var i in e)if(!n||n(i,t,e))try{t[i]=e[i]}catch(o){}return e&&e.hasOwnProperty("call")&&(!n||n(t,e,"call"))&&(t.call=e.call),t},Csprite.extend(Csprite,{version:"0.1.0",author:"chao.gao"}),Csprite.init()})(),function(t){var e=t.Scene=function(t,e,r){this.sceneOpts=t,this.canvasOpts=e,this.loaderOpts=r,this.container=document.getElementById(t.container),this.layersContainer=new Csprite.LayersContainer(this),this.render=new Csprite.Render(this,e),this.size=new Csprite.Helper.Size(e),this.tile=new Csprite.Feature.Tile(t.tile),this.grid=new Csprite.Feature.Grid(this.size,{tile:this.tile}),this.generateLayers(),this.loader=new Csprite.State.StateLoader(this.loaderOpts,this,this.loaderFinish.bind(this)),this.render.start(this.loader),this.render.addListener("selectedfeature",this.selectedfeature.bind(this))};e.prototype=Object.clone(EventEmitter.prototype),Csprite.extend(e.prototype,{generateLayers:function(){this.backgroundLayer=new Csprite.Layer({name:"base-backgroundLayer"}),this.addLayer(this.backgroundLayer),this.mainLayer=new Csprite.Layer({name:"base-mainLayer"}),this.addLayer(this.mainLayer),this.textLayer=new Csprite.Layer({name:"base-textLayer"}),this.addLayer(this.textLayer)},addLayer:function(t){this.layersContainer.addLayer(t)},getLayer:function(t){this.layersContainer.getByName(t)},getFeature:function(t){var e=parseInt(t/1e4),r=this.layersContainer.layers[e];return r.getFeature(t)},loaderFinish:function(){console.log("loaderFinish")},update:function(){this.layersContainer.update()},getLayers:function(){return this.layersContainer.getSortedLayers()},selectedfeature:function(t){this.emitEvent("selectedfeature",[t])},saveImage:function(){return this.render.convertLayerImage(this.mainLayer)}})}(Csprite),function(t){var e=t.Render=function(t,e){this.scene=t,this.canvas=this.createCanvas(e),this.context=this.canvas.getContext("2d"),this.selector=this.createSelector(e),this.selectorContext=this.selector.getContext("2d"),this.initEvent(),this.interval=1e3/Csprite.Const.FPS,this.state="",this.now="",this.then=Date.now(),this.loop()};e.prototype=Object.clone(EventEmitter.prototype),e.Const={},e.Const.Stroke=1,e.Const.Fill=2,e.Const.Reset=3,Csprite.extend(e.prototype,{createCanvas:function(t){var e=document.createElement("canvas");return e.width=t.width,e.height=t.height,this.scene.container.appendChild(e),e},initEvent:function(){var t=this.canvas;t.addEventListener("click",this.getFeatureIdFromEvent.bind(this))},createSelector:function(t){var e=document.createElement("canvas");return e.width=t.width,e.height=t.height,e},start:function(t){t.next()},setDrawCb:function(t){this.cb=t},loop:function(){var t,e=(this.state,this.cb);this.now=Date.now(),t=this.now-this.then,requestAnimFrame(this.loop.bind(this,e)),(t>this.interval||e&&!e.excuted)&&(this.scene.update(),e&&(e(),e.excuted=!0),this.redraw(),this.then=this.now-t%this.interval)},redraw:function(){var t=this,e=this.scene.getLayers();this.reset(),e.forEach(function(e){t.redrawLayer(e)})},redrawLayer:function(t){var e=this,r=t.getFeatures();r.forEach(function(t){e.drawFeature(t)})},convertLayerImage:function(t){return this.reset(),this.redrawLayer(t),Canvas2Image.saveAsPNG(this.canvas,"",!0)},reset:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},setStyle:function(t,e){this.context.globalAlpha=t.opacity,e==Csprite.Render.Const.Stroke&&t.border&&(this.context.lineWidth=t.border.borderWidth,this.context.strokeStyle=t.border.borderColor),e==Csprite.Render.Const.Fill&&(this.context.fillStyle=t.backgroundColor),e==Csprite.Render.Const.Reset&&(this.context.globalAlpha=1,this.context.lineWidth=1),t.font&&(this.context.font=t.font),t.textAlign&&(this.context.textAlign=t.textAlign)},setSelectorStyle:function(t,e,r){var n=this.featureIdToHex(t);this.selectorContext.globalAlpha=1,r==Csprite.Render.Const.Stroke&&e.border&&(this.selectorContext.lineWidth=e.border.borderWidth+2,this.selectorContext.strokeStyle=n),r==Csprite.Render.Const.Fill&&(this.selectorContext.fillStyle=n),r==Csprite.Render.Const.Reset&&(this.selectorContext.globalAlpha=1,this.selectorContext.lineWidth=1),e.font&&(this.selectorContext.font=e.font),e.textAlign&&(this.selectorContext.textAlign=e.textAlign)},drawFeature:function(t){switch(t.type){case"Image":this.drawFeatureImage(t);break;case"Text":this.drawFeatureText(t)}},drawFeatureImage:function(t){function e(){var e=i.width||r.width,o=i.height||r.height;n.setStyle(i),n.context.drawImage(r,i.position.x,i.position.y,e,o),n.setStyle(i,Csprite.Render.Const.Reset),n.setSelectorStyle(t.id,i,Csprite.Render.Const.Fill),n.selectorContext.fillRect(i.position.x,i.position.y,e,o),n.setSelectorStyle(t.id,i,Csprite.Render.Const.Reset)}var r,n=this,i=t.style;t.image?(r=t.image,e()):(r=new Image,r.onload=e,r.src=t.imageSrc)},drawFeatureText:function(t){var e=t.text,r=t.style;this.setStyle(r,Csprite.Render.Const.Fill),this.context.fillText(e,r.position.x,r.position.y),r.border&&(this.setStyle(r,Csprite.Render.Const.Stroke),this.context.strokeText(e,r.position.x,r.position.y)),this.setStyle(r,Csprite.Render.Const.Reset)},featureIdToHex:function(t){var e=t;e>=16777216&&(this.hitOverflow=e-16777215,e=e%16777216+1);var r="000000"+e.toString(16),n=r.length;return r="#"+r.substring(n-6,n)},getFeatureIdFromEvent:function(t){var e,r=t.layerX,n=t.layerY,i=this.selectorContext.getImageData(r,n,1,1).data;if(255===i[3]){var o=i[2]+256*(i[1]+256*i[0]);if(o)try{e=this.scene.getFeature(o)}catch(a){}}this.emitEvent("selectedfeature",[Csprite.extend(t,{feature:e})])}})}(Csprite),function(t){var e=t.FeaturesContainer=function(){this.features=[],this.rulers=[]};Csprite.extend(e.prototype,{add:function(t){this.valid(t)&&this.features.push(t)},remove:function(t){var e=this.features.indexOf(t);e>=0&&this.features.splice(e,1)},valid:function(){var t=this.rulers;return t.forEach(function(){}),!0},update:function(){var t=this.features;t.forEach(function(t){t.update()})}})}(Csprite),function(t){var e=t.LayersContainer=function(t){this.layers=[],this.index=0,this.scene=t};Csprite.extend(e.prototype,{addLayer:function(t,e){this.valid(t)&&(e=e||this.index++,t.setIndex(e),this.layers.push(t))},valid:function(){return!0},update:function(){var t=this.getSortedLayers();t.forEach(function(t){t.update()})},getSortedLayers:function(){var t=this.layers;return t.sort(function(t,e){return t.index-e.index}),t}})}(Csprite),function(t){var e=t.Layer=function(t){this.option=t,this.name=t.name,this.featuresContainer=new Csprite.FeaturesContainer(this),this.index=0};Csprite.extend(e.prototype,{addFeature:function(t){this.featuresContainer.add(t),t.layer=this,this.generateFeatureId(t)},generateFeatureId:function(t){t.id=this.currentFeatureId++},removeFeature:function(t){this.featuresContainer.remove(t)},getFeatures:function(){return this.featuresContainer.features},getFeature:function(t){for(var e=this.featuresContainer.features,r=0,n=e.length;n>r;r++)if(e[r].id==t)return e[r]},update:function(){this.featuresContainer.update()},setIndex:function(t){this.index=t,this.startFeatureId=1e4*t,this.currentFeatureId=this.startFeatureId}})}(Csprite),function(t){var e=t.Style=function(t){this.merge(t)};e.getBorder=function(t){var e;return"string"!=typeof t?t:(e=t.split(" "),{borderWidth:e[0],borderStyle:e[1],borderColor:e[2]})},Csprite.extend(e.prototype,{merge:function(t){for(var e in t)this.addStyle(e,t[e])},addStyle:function(t,e){this.valid(t,e)&&(this[t]=e)},valid:function(){return!0}})}(Csprite),function(t){var e=t.Feature=function(t){this.style=t,this.animations=[]};e.prototype=Object.clone(EventEmitter.prototype),Csprite.extend(e.prototype,{update:function(){var t=this,e=this.animations;e.forEach(function(e){e.mode!=Csprite.Animation.Mode.End?(e.next(),t.applyAnimation(e)):t.removeAnimation(e)})},addAnimation:function(t){this.animations.push(t)},removeAnimation:function(t){var e=this.animations.indexOf(t);e>=0&&this.animations.splice(e,1)},applyAnimation:function(t){var e=t.getStyle();this.style.merge(e)}})}(Csprite),function(t){var e=t.Text=function(t,e){var r=new Csprite.Style({backgroundColor:e.backgroundColor,font:e.font,textAlign:e.textAlign,border:Csprite.Style.getBorder(e.border),position:{x:e.position.x,y:e.position.y}});Csprite.Feature.apply(this,[r]),this.text=t};e.prototype=new Csprite.Feature,e.prototype.contructor=e,Csprite.extend(e.prototype,{type:"Text"})}(Csprite.Feature),function(t){var e=t.Image=function(t,e){var r=this,n=new Csprite.Style({width:t.width,height:t.height,position:{x:e.position.x,y:e.position.y}});if(Csprite.Feature.apply(this,[n]),"string"==typeof t){var i=new window.Image;i.onload=function(){r.image=i,r.style.width=i.width,r.style.height=i.height,r.emitEvent("loaded",[{target:r,image:i}])},i.src=t}else this.image=t};e.prototype=new Csprite.Feature,e.prototype.contructor=e,Csprite.extend(e.prototype,{type:"Image"})}(Csprite.Feature),function(t){t.Grid=function(t,e){var r=t.width,n=t.height,i=e.tile;this.cols=parseInt(r/i.fWidth),this.rows=parseInt(n/i.fHeight)}}(Csprite.Feature),function(t){t.Tile=function(t){this.width=t.width,this.height=t.height,this.paddingX=t.paddingX,this.paddingY=t.paddingY,this.fWidth=t.width+2*t.paddingX,this.fHeight=t.height+2*t.paddingY}}(Csprite.Feature),function(t){var e=t.Animation=function(){this.mode=e.Mode.Run};e.Mode={},e.Mode.Run=0,e.Mode.Stop=1,Csprite.extend(e.prototype,{end:function(){this.mode=e.Mode.Stop}})}(Csprite),function(t){var e=t.Opacity=function(t,e){this.option=Csprite.extend(Object.clone(Csprite.Animation.Opacity.Option),e),this.currentOpacity=this.option.from,this.opacityDifference=this.option.to-this.option.from,Csprite.Animation.apply(this)};e.prototype=new Csprite.Animation,e.prototype.constructor=e,e.Option={from:0,to:1,duration:1},Csprite.extend(e.prototype,{next:function(t){t=t||Csprite.Const.FPS,this.differ&&this.lastFps&&this.lastFps==t||(this.differ=this.opacityDifference/(this.option.duration*t)),this.currentOpacity=this.currentOpacity+this.differ,this.lastFps=t,this.checkEnd()},getStyle:function(){return new Csprite.Style({opacity:this.currentOpacity})},checkEnd:function(){return this.differ>0&&this.currentOpacity>=this.option.to?(this.currentOpacity=this.option.to,this.mode=Csprite.Animation.Mode.End,void 0):0>this.differ&&this.currentOpacity<=this.option.to?(this.currentOpacity=this.option.to,this.mode=Csprite.Animation.Mode.End,void 0):void 0}})}(Csprite.Animation),function(t){var e=t.Helper=function(){};e.calcPostion=function(t,e){var r,n,i=t.tile,o=parseInt(e/t.grid.cols),a=e-o*t.grid.cols;return r=a*i.fWidth+i.paddingX,n=o*i.fHeight+i.paddingY,{x:r,y:n}},e.centerPosition=function(t){return{x:parseInt(t.size.width/2),y:parseInt(t.size.height/2)}}}(Csprite),function(t){t.Size=function(t){this.width=t.width,this.height=t.height}}(Csprite.Helper),function(t){var e=t.State=function(t,e,r){var n=this;this.scene=t,this.cb=r,this.nextSetp=!1,this.setp=0,Csprite.extend(this,e),this.runnerStack=[],[this.setup,this.run,this.end].forEach(function(t){t&&n.runnerStack.push(t.bind(n))})};e.prototype=Object.clone(EventEmitter.prototype),Csprite.extend(e.prototype,{next:function(){var t=this.scene.render;this.runnerStack[this.setp]?(t.setDrawCb(this.runnerStack[this.setp]),this.setp++):(t.setDrawCb(),this.cb())}})}(Csprite),function(t){var e=t.StateLoader=function(t,r,n,i){this.mode=e.Mode.ToLoad,this.loaderOpts=t,this.loadedCount=0,Csprite.State.call(this,r,i,n),this.loading=new Csprite.Feature.Text("Loading",{backgroundColor:"red",textAlign:"center",font:"48pt Helvetica",border:"2px solid black",position:Csprite.Helper.centerPosition(this.scene)}),this.flashLoader=document.getElementById("swfloader"),this.registeCb(this.imageLoaded),this.load()};window.Imageloaded=function(t,e){window._imageLoaded&&window._imageLoaded(t,e)},e.Mode={},e.Mode.ToLoad=0,e.Mode.Loading=1,e.Mode.Loaded=2,e.prototype=new Csprite.State,e.prototype.constructor=e,Csprite.extend(e.prototype,{load:function(){var t=this,r=(this.loaderOpts,this.loaderOpts.resources);this.mode=e.Mode.Loading,r.forEach(function(e,r){t.flashLoader.getImage(e.src,r)})},registeCb:function(t,e){e=e||this,window._imageLoaded=t.bind(e)},imageLoaded:function(t,r){var n=new Image;n.src=["data:image/png;base64",t].join(","),this.onload({img:n,index:r}),this.loadedCount++,this.loadedCount==this.loaderOpts.resources.length-1&&(this.mode=e.Mode.Loaded)},onload:function(t){var e;e=new Csprite.Feature.Image(t.img,{position:Csprite.Helper.calcPostion(this.scene,t.index)}),e.addAnimation(new Csprite.Animation.Opacity),this.scene.mainLayer.addFeature(e),this.loading.text="Loading("+this.loadedCount+"/"+this.loaderOpts.resources.length+")"},setup:function(){this.scene.textLayer.addFeature(this.loading),this.next()},run:function(){this.mode==e.Mode.Loaded&&this.loading&&(this.scene.textLayer.removeFeature(this.loading),delete this.loading,this.next())},end:function(){this.emitEvent("end"),this.next()}})}(Csprite.State);